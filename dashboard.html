<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Dashboard - Snack Voting Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { 
            font-family: 'Poppins', sans-serif;
            scroll-behavior: smooth;
        }
        
        /* Yellow/Gold gradient backgrounds */
        .game-gradient-bg {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 25%, #FF8C00 50%, #B8860B 100%);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }
        
        .snack-card {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            background: linear-gradient(145deg, #fff9e6, #fff0cc);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }
        
        .snack-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(184, 134, 11, 0.2);
            border: 2px solid #FFD700;
        }
        
        .snack-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
        }
        
        .snack-card:hover::before {
            left: 100%;
        }
        
        /* Floating animation for emojis */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.9); }
        }
        
        @keyframes confetti {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(500px) rotate(360deg); opacity: 0; }
        }
        
        @keyframes vote-pop {
            0% { transform: scale(0.8); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes sparkle {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            100% { transform: scale(1) rotate(180deg); opacity: 0; }
        }
        
        .floating-emoji {
            animation: float 3s ease-in-out infinite;
        }
        
        .glow-effect {
            animation: pulse-glow 2s infinite;
        }
        
        .online-dot {
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px #FFD700;
        }
        
        /* Game button styles - Yellow/Gold theme */
        .game-button {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
            border: none;
            border-radius: 50px;
            color: #2C1C00;
            padding: 14px 32px;
            font-weight: 800;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 15px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }
        
        .game-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.6);
            color: #1C0E00;
        }
        
        .game-button:active {
            transform: translateY(-1px);
        }
        
        .game-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.7);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .game-button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 1;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        /* Custom scrollbar - Gold theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #2C1C00;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 10px;
        }
        
        /* Progress bar animation */
        .progress-bar {
            transition: width 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Shine effect for cards */
        .shine-effect {
            position: relative;
            overflow: hidden;
        }
        
        .shine-effect::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 30%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 70%
            );
            transform: rotate(30deg);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
        }
        
        /* Score counter animation */
        @keyframes score-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .score-pop {
            animation: score-pop 0.5s ease;
        }
        
        /* Particle container */
        .particles-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Snack card selected effect */
        .snack-card.selected {
            border: 3px solid #FFD700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
            background: linear-gradient(145deg, #fff5d6, #ffebad);
        }
        
        /* Compact snack cards for better readability */
        .snack-card-compact {
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            background: linear-gradient(145deg, #fff9e6, #fff0cc);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            padding: 1rem;
        }
        
        .snack-card-compact:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 10px 25px rgba(184, 134, 11, 0.15);
            border: 2px solid #FFD700;
        }
        
        .snack-card-compact .snack-emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .snack-card-compact .snack-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .snack-card-compact .snack-votes {
            font-size: 0.875rem;
            color: #666;
        }
        
        .snack-card-compact .vote-button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        /* Voted badge - Gold theme */
        .voted-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #2C1C00;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 900;
            font-size: 12px;
            transform: rotate(15deg);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
            z-index: 2;
            border: 2px solid #FFD700;
        }
        
        /* Loading animation */
        @keyframes loading-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }
        
        .loading-pulse {
            animation: loading-pulse 1.5s infinite;
        }
        
        /* Glitch effect for fun */
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        
        .glitch:hover {
            animation: glitch 0.3s;
        }
        
        /* Notification popup */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1000;
            animation: slideInRight 0.5s, slideOutRight 0.5s 2.5s;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* 3D effect for cards */
        .card-3d {
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        
        .card-3d:hover .card-content {
            transform: rotateY(10deg) rotateX(5deg);
        }
        
        .card-content {
            transition: transform 0.5s;
        }
        
        /* Gold text colors */
        .gold-text {
            color: #FFD700;
        }
        
        .dark-gold-bg {
            background-color: #2C1C00;
        }
        
        .gold-gradient-text {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Enhanced Game Header */
        .game-header-enhanced {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 25%, #FF8C00 50%, #B8860B 100%);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.4);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .game-header-title {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.1em;
        }
        
        .game-header-subtitle {
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* Responsive Design Enhancements */
        @media (max-width: 768px) {
            .container-padding {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .mobile-stack {
                flex-direction: column;
            }
            
            .mobile-full-width {
                width: 100%;
            }
            
            .mobile-center-text {
                text-align: center;
            }
            
            .mobile-hide {
                display: none;
            }
            
            .mobile-show {
                display: block;
            }
            
            .game-button {
                padding: 12px 24px;
                font-size: 14px;
            }
            
            .snack-card {
                margin-bottom: 1rem;
            }
            
            .nav-buttons {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            /* Compact snack cards on mobile */
            .snack-card-compact {
                padding: 0.75rem;
            }
            
            .snack-card-compact .snack-emoji {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }
            
            .snack-card-compact .snack-name {
                font-size: 0.875rem;
            }
            
            .snack-card-compact .snack-votes {
                font-size: 0.75rem;
            }
            
            .snack-card-compact .vote-button {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
                margin-top: 0.25rem;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem !important;
            }
            
            h2 {
                font-size: 1.5rem !important;
            }
            
            h3 {
                font-size: 1.2rem !important;
            }
            
            .game-button {
                padding: 10px 20px;
                font-size: 13px;
            }
            
            .snack-card {
                padding: 1rem !important;
            }
            
            /* Single column for very small screens */
            .grid-cols-1.sm\\:grid-cols-2.lg\\:grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
            
            /* Even more compact for very small screens */
            .snack-card-compact {
                padding: 0.5rem;
            }
            
            .snack-card-compact .snack-emoji {
                font-size: 1.25rem;
            }
            
            .snack-card-compact .snack-name {
                font-size: 0.8125rem;
            }
            
            /* Mobile Game Header adjustments */
            .game-header-enhanced {
                padding: 1.5rem 1rem !important;
            }
            
            .game-header-title {
                font-size: 1.75rem !important;
                letter-spacing: 0.05em !important;
            }
            
            .game-header-subtitle {
                font-size: 1rem !important;
            }
        }
        
        /* Enhanced focus states for accessibility */
        *:focus {
            outline: 2px solid #FFD700;
            outline-offset: 2px;
        }
        
        /* Improved touch targets for mobile */
        @media (max-width: 768px) {
            button, 
            .game-button,
            .snack-card {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-yellow-900 to-amber-900 min-h-screen">
    <!-- Loading Screen with Gold Theme -->
    <div id="loading" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center">
        <div class="text-center relative">
            <!-- Animated particles in background -->
            <div class="absolute inset-0 flex justify-center items-center">
                <div class="w-64 h-64 rounded-full border-4 border-yellow-500 border-opacity-20 animate-ping"></div>
            </div>
            
            <div class="relative z-10">
                <div class="text-8xl mb-6 floating-emoji">üçø</div>
                <h1 class="text-4xl font-bold bg-gradient-to-r from-yellow-400 via-amber-500 to-orange-500 bg-clip-text text-transparent mb-4">
                    SNACK VOTE GAME
                </h1>
                <div class="flex items-center justify-center space-x-2 mb-6">
                    <div class="w-3 h-3 bg-yellow-500 rounded-full loading-pulse"></div>
                    <div class="w-3 h-3 bg-amber-500 rounded-full loading-pulse" style="animation-delay: 0.2s"></div>
                    <div class="w-3 h-3 bg-orange-500 rounded-full loading-pulse" style="animation-delay: 0.4s"></div>
                </div>
                <p class="text-gray-300 text-xl">Loading your gaming dashboard...</p>
            </div>
        </div>
    </div>
    
    <!-- Particle container -->
    <div id="particles" class="particles-container"></div>
    
    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-24 right-6 z-50 w-80 space-y-3"></div>
    
    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navigation - Gold Game Style -->
        <nav class="bg-gray-800 bg-opacity-90 backdrop-blur-lg shadow-2xl sticky top-0 z-40 border-b border-yellow-500 border-opacity-40">
            <div class="max-w-7xl mx-auto px-2 md:px-4 container-padding">
                <div class="flex justify-between items-center h-16 md:h-20 gap-2 md:gap-0">
                    <!-- Logo with Gold Vibes -->
                    <div class="flex items-center gap-2 md:gap-3">
                        <div class="relative">
                            <div class="text-2xl md:text-4xl floating-emoji">üçø</div>
                            <div class="absolute -top-1 -right-1 w-2 h-2 md:w-3 md:h-3 bg-yellow-400 rounded-full online-dot"></div>
                        </div>
                        <div>
                            <h1 class="text-lg md:text-2xl font-bold gold-gradient-text glitch cursor-pointer">SNACK VOTE</h1>
                            <p class="text-xs text-gray-300 hidden sm:block" id="welcomeUser">Welcome, Player!</p>
                        </div>
                    </div>
                    
                    <!-- Game Stats -->
                    <div class="flex items-center gap-3 md:gap-6 nav-buttons">
                        <div class="flex items-center gap-3 md:gap-6 mobile-stack mobile-center-text">
                            <!-- Live Players -->
                            <div class="flex items-center gap-1 md:gap-2 cursor-pointer hover:scale-110 transition-transform" onclick="showOnlineUsers()">
                                <div class="relative">
                                    <div class="w-3 h-3 md:w-4 md:h-4 bg-yellow-400 rounded-full online-dot"></div>
                                    <div class="absolute -top-1 -right-1 w-1 h-1 md:w-2 md:h-2 bg-red-500 rounded-full animate-ping"></div>
                                </div>
                                <span class="text-white font-bold text-sm md:text-base">
                                    <span id="onlineCount" class="score-pop">0</span> <span class="text-gray-300 hidden sm:inline">LIVE</span>
                                </span>
                            </div>
                            
                            <!-- Votes Today -->
                            <div class="flex items-center gap-1 md:gap-2">
                                <i class="fas fa-vote-yea text-yellow-400 text-base md:text-xl"></i>
                                <span class="text-white font-bold text-sm md:text-base">
                                    <span id="totalVotesToday" class="score-pop">0</span> <span class="text-gray-300 hidden sm:inline">VOTES</span>
                                </span>
                            </div>
                            
                            <!-- Game Timer -->
                            <div class="flex items-center gap-1 md:gap-2 bg-gray-700 px-2 py-1 md:px-4 md:py-2 rounded-xl glow-effect">
                                <i class="fas fa-clock text-yellow-400 text-base md:text-xl"></i>
                                <span id="countdown" class="text-white font-bold text-sm md:text-xl">--:--:--</span>
                            </div>
                        </div>
                        
                        <!-- Player Profile -->
                        <div class="relative group">
                            <button class="flex items-center gap-2 bg-gradient-to-r from-yellow-700 to-amber-700 hover:from-yellow-600 hover:to-amber-600 rounded-full px-3 py-2 transition-all duration-300 shadow-lg hover:shadow-xl mobile-full-width">
                                <div class="relative">
                                    <span id="userAvatar" class="text-lg">üë§</span>
                                    <div class="absolute -bottom-1 -right-1 w-2 h-2 bg-yellow-400 rounded-full border border-gray-800"></div>
                                </div>
                                <div class="text-left hidden sm:block">
                                    <span id="userName" class="font-bold text-white text-sm block"></span>
                                    <span class="text-xs text-gray-300">Level 1</span>
                                </div>
                                <i class="fas fa-chevron-down text-gray-300 text-xs ml-1 mobile-hide"></i>
                            </button>
                            <div class="absolute right-0 mt-2 md:mt-3 w-48 md:w-56 bg-gray-800 rounded-2xl shadow-2xl py-2 hidden group-hover:block border border-gray-700 z-50 mobile-stack mobile-full-width">
                                <a href="#" class="block px-3 py-2 md:px-4 md:py-3 text-sm md:text-base text-gray-300 hover:text-white hover:bg-yellow-700 transition" onclick="showProfile()">
                                    <i class="fas fa-user mr-2 md:mr-3"></i> Player Profile
                                </a>
                                <a href="#" class="block px-3 py-2 md:px-4 md:py-3 text-sm md:text-base text-gray-300 hover:text-white hover:bg-yellow-700 transition" onclick="showChangePassword()">
                                    <i class="fas fa-key mr-2 md:mr-3"></i> Change Password
                                </a>
                                <div class="border-t border-gray-700 my-1 md:my-2"></div>
                                <a href="#" class="block px-3 py-2 md:px-4 md:py-3 text-sm md:text-base text-red-400 hover:text-red-300 hover:bg-red-900 transition" onclick="logout()">
                                    <i class="fas fa-sign-out-alt mr-2 md:mr-3"></i> Logout Game
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8 container-padding">
            <!-- Game Header -->
            <div class="text-center mb-8 md:mb-12 relative">
                <div class="relative overflow-hidden rounded-3xl px-8 py-10 md:px-12 md:py-14 shadow-2xl game-header-enhanced shine-effect mobile-full-width">
                    <h2 class="text-4xl md:text-5xl font-bold text-white mb-4 tracking-wider game-header-title">üéØ TODAY'S SNACK BATTLE</h2>
                    <p class="text-lg md:text-2xl text-gray-100 font-medium game-header-subtitle">Cast your vote before the timer runs out!</p>
                    <div class="absolute top-0 left-0 w-24 h-24 bg-white bg-opacity-10 rounded-full -translate-x-12 -translate-y-12"></div>
                    <div class="absolute bottom-0 right-0 w-40 h-40 bg-white bg-opacity-5 rounded-full translate-x-16 translate-y-16"></div>
                    <div class="absolute top-1/2 left-1/2 w-20 h-20 bg-white bg-opacity-5 rounded-full -translate-x-1/2 -translate-y-1/2"></div>
                </div>
            </div>
            
            <!-- Gaming Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Voting Arena -->
                <div class="lg:col-span-2">
                    <!-- Game Mode Indicator -->
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
                        <h3 class="text-2xl font-bold text-white mobile-center-text">
                            <i class="fas fa-gamepad mr-3 text-yellow-400"></i>
                            SELECT YOUR SNACK
                        </h3>
                        <div class="bg-gray-800 px-4 py-2 rounded-xl mobile-full-width md:w-auto">
                            <span class="text-gray-300">Votes Remaining: </span>
                            <span id="votesRemaining" class="font-bold text-white text-xl">1</span>
                        </div>
                    </div>
                    
                    <!-- Snack Cards Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4 mb-8" id="snackGrid">
                        <!-- Snack cards will load here -->
                    </div>
                    
                    <!-- Today's Players -->
                    <div class="bg-gray-800 bg-opacity-70 backdrop-blur-lg rounded-3xl p-6 md:p-8 shadow-2xl border border-yellow-500 border-opacity-20">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <h3 class="text-2xl font-bold text-white mobile-center-text">
                                <i class="fas fa-users text-yellow-400 mr-3"></i>
                                TODAY'S PLAYERS
                            </h3>
                            <span class="px-4 py-2 bg-gradient-to-r from-yellow-600 to-amber-600 text-white rounded-full font-bold mobile-full-width md:w-auto text-center" id="voterCount">
                                0 PLAYERS
                            </span>
                        </div>
                        <div id="votersList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                            <!-- Voters will load here -->
                        </div>
                    </div>
                </div>
                
                <!-- Game Sidebar -->
                <div class="space-y-8">
                    <!-- Live Players -->
                    <div class="bg-gray-800 bg-opacity-70 backdrop-blur-lg rounded-3xl p-6 md:p-8 shadow-2xl border border-yellow-500 border-opacity-20">
                        <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
                            <h3 class="text-2xl font-bold text-white mobile-center-text">
                                <i class="fas fa-wifi text-yellow-400 mr-3"></i>
                                LIVE PLAYERS
                            </h3>
                            <div class="px-4 py-2 bg-gradient-to-r from-yellow-600 to-amber-600 text-white rounded-full font-bold mobile-full-width md:w-auto text-center">
                                <span id="onlineNowCount" class="score-pop">0</span> ONLINE
                            </div>
                        </div>
                        <div id="onlineUsersList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                            <!-- Online users will load here -->
                        </div>
                    </div>
                    
                    <!-- Player Stats -->
                    <div class="bg-gradient-to-br from-yellow-800 via-amber-700 to-orange-600 rounded-3xl p-6 md:p-8 text-white shadow-2xl">
                        <h3 class="text-2xl font-bold mb-6 text-center md:text-left">üéÆ PLAYER STATS</h3>
                        <div class="space-y-5">
                            <div class="flex justify-between items-center bg-white bg-opacity-10 p-4 rounded-xl hover:bg-white hover:bg-opacity-20 transition">
                                <span class="font-medium">Total Votes</span>
                                <span class="text-3xl font-bold score-pop" id="myTotalVotes">0</span>
                            </div>
                            <div class="flex justify-between items-center bg-white bg-opacity-10 p-4 rounded-xl hover:bg-white hover:bg-opacity-20 transition">
                                <span>Voted Today</span>
                                <span id="votedToday" class="px-4 py-2 rounded-full font-bold bg-gradient-to-r from-yellow-600 to-amber-600">
                                    NO
                                </span>
                            </div>
                            <div class="flex justify-between items-center bg-white bg-opacity-10 p-4 rounded-xl hover:bg-white hover:bg-opacity-20 transition">
                                <span>Member Since</span>
                                <span id="memberSince" class="font-bold">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="bg-gray-800 bg-opacity-70 backdrop-blur-lg rounded-3xl p-6 md:p-8 shadow-2xl border border-yellow-500 border-opacity-20">
                        <h3 class="text-2xl font-bold text-white mb-6 text-center md:text-left">‚ö° GAME ACTIONS</h3>
                        <div class="space-y-4">
                            <button onclick="showLeaderboard()" class="w-full flex items-center gap-4 bg-gradient-to-r from-yellow-700 to-yellow-600 hover:from-yellow-600 hover:to-yellow-500 text-white rounded-xl p-4 transition-all duration-300 hover:scale-[1.02] shadow-lg mobile-full-width">
                                <i class="fas fa-trophy text-2xl"></i>
                                <span class="font-bold">VIEW LEADERBOARD</span>
                            </button>
                            <button onclick="showHistory()" class="w-full flex items-center gap-4 bg-gradient-to-r from-amber-700 to-amber-600 hover:from-amber-600 hover:to-amber-500 text-white rounded-xl p-4 transition-all duration-300 hover:scale-[1.02] shadow-lg mobile-full-width">
                                <i class="fas fa-history text-2xl"></i>
                                <span class="font-bold">VOTING HISTORY</span>
                            </button>
                            <button onclick="refreshData()" class="w-full flex items-center gap-4 bg-gradient-to-r from-yellow-600 to-green-600 hover:from-yellow-500 hover:to-green-500 text-white rounded-xl p-4 transition-all duration-300 hover:scale-[1.02] shadow-lg mobile-full-width">
                                <i class="fas fa-sync-alt text-2xl"></i>
                                <span class="font-bold">REFRESH DATA</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Enhanced Modals -->
    <div id="profileModal" class="fixed inset-0 bg-black/80 backdrop-blur-lg hidden items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-6 md:p-8 max-w-md w-full border border-yellow-500 border-opacity-30 shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold gold-gradient-text">üë§ PLAYER PROFILE</h3>
                <button onclick="hideProfile()" class="text-gray-400 hover:text-yellow-400 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="profileContent" class="text-white"></div>
        </div>
    </div>
    
    <div id="changePasswordModal" class="fixed inset-0 bg-black/80 backdrop-blur-lg hidden items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-6 md:p-8 max-w-md w-full border border-yellow-500 border-opacity-30 shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold gold-gradient-text">üîê CHANGE PASSWORD</h3>
                <button onclick="hideChangePassword()" class="text-gray-400 hover:text-yellow-400 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="changePasswordForm" class="space-y-6">
                <div>
                    <label class="block text-gray-300 mb-3">Current Password</label>
                    <input type="password" id="currentPassword" 
                        class="w-full px-5 py-4 rounded-xl bg-gray-700 border border-gray-600 text-white focus:border-yellow-500 focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-gray-300 mb-3">New Password</label>
                    <input type="password" id="newPassword" 
                        class="w-full px-5 py-4 rounded-xl bg-gray-700 border border-gray-600 text-white focus:border-yellow-500 focus:outline-none transition">
                    <p class="text-gray-500 text-sm mt-2">Must be at least 6 characters</p>
                </div>
                <div>
                    <label class="block text-gray-300 mb-3">Confirm New Password</label>
                    <input type="password" id="confirmNewPassword" 
                        class="w-full px-5 py-4 rounded-xl bg-gray-700 border border-gray-600 text-white focus:border-yellow-500 focus:outline-none transition">
                </div>
                <div id="passwordMessage" class="hidden p-4 rounded-xl"></div>
                <button type="submit" class="w-full bg-gradient-to-r from-yellow-600 to-amber-600 hover:from-yellow-500 hover:to-amber-500 text-white py-4 rounded-xl font-bold text-lg transition-all duration-300 hover:scale-[1.02]">
                    UPDATE PASSWORD
                </button>
            </form>
        </div>
    </div>
    
    <div id="onlineUsersModal" class="fixed inset-0 bg-black/80 backdrop-blur-lg hidden items-center justify-center z-50 p-4">
        <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-6 md:p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto border border-yellow-500 border-opacity-30 shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-2xl font-bold gold-gradient-text">üë• LIVE PLAYERS</h3>
                <button onclick="hideOnlineUsers()" class="text-gray-400 hover:text-yellow-400 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="onlineUsersModalContent"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://snack-voting-api-production.up.railway.app/api';
        const VOTING_END_HOUR = 17; // 5 PM
        
        // Global state
        let state = {
            user: null,
            token: null,
            ws: null,
            onlineUsers: [],
            snacks: [],
            todayVotes: [],
            hasVotedToday: false,
            refreshInterval: null,
            wsHeartbeatInterval: null,
            wsReconnectInterval: null
        };
        
        // Initialize on page load
        $(document).ready(async () => {
            await initializeApp();
            createParticles();
        });
        
        // Create background particles with gold theme
        function createParticles() {
            const container = $('#particles');
            const colors = ['#FFD700', '#FFA500', '#FF8C00', '#FFD54F', '#FFECB3'];
            
            for (let i = 0; i < 25; i++) {
                const particle = $('<div class="absolute rounded-full"></div>');
                const size = Math.random() * 8 + 2;
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                particle.css({
                    width: `${size}px`,
                    height: `${size}px`,
                    background: color,
                    left: `${Math.random() * 100}%`,
                    top: `${Math.random() * 100}%`,
                    opacity: Math.random() * 0.4 + 0.1,
                    animation: `float ${Math.random() * 10 + 10}s infinite ease-in-out`,
                    animationDelay: `${Math.random() * 5}s`,
                    filter: 'blur(1px)'
                });
                
                container.append(particle);
            }
        }
        
        // Show game notification with gold theme
        function showNotification(message, type = 'info') {
            const types = {
                success: { bg: 'bg-gradient-to-r from-yellow-600 to-green-600', icon: 'fas fa-check-circle' },
                error: { bg: 'bg-gradient-to-r from-red-600 to-amber-600', icon: 'fas fa-exclamation-circle' },
                info: { bg: 'bg-gradient-to-r from-yellow-600 to-amber-600', icon: 'fas fa-info-circle' }
            };
            
            const config = types[type] || types.info;
            
            const notification = $(`
                <div class="notification">
                    <div class="${config.bg} text-white p-4 rounded-xl shadow-2xl flex items-center gap-3 border border-yellow-500 border-opacity-30">
                        <i class="${config.icon} text-xl"></i>
                        <span class="font-bold">${message}</span>
                    </div>
                </div>
            `);
            
            $('#notificationContainer').append(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Create confetti animation with gold theme
        function createConfetti(x, y) {
            const colors = ['#FFD700', '#FFA500', '#FF8C00', '#FFD54F', '#FFF176', '#FFECB3'];
            const container = $('body');
            
            for (let i = 0; i < 60; i++) {
                const confetti = $('<div class="absolute w-3 h-3"></div>');
                const color = colors[Math.floor(Math.random() * colors.length)];
                const rotation = Math.random() * 360;
                
                confetti.css({
                    background: color,
                    left: x,
                    top: y,
                    borderRadius: Math.random() > 0.5 ? '50%' : '0%',
                    zIndex: 1000,
                    filter: 'brightness(1.1)'
                });
                
                container.append(confetti);
                
                const animation = confetti[0].animate([
                    { 
                        transform: `translateY(0) rotate(0deg)`,
                        opacity: 1
                    },
                    { 
                        transform: `translateY(500px) translateX(${Math.random() * 200 - 100}px) rotate(${rotation}deg)`,
                        opacity: 0
                    }
                ], {
                    duration: Math.random() * 1000 + 1000,
                    easing: 'cubic-bezier(0.215, 0.610, 0.355, 1)'
                });
                
                animation.onfinish = () => confetti.remove();
            }
        }
        
        // Create sparkle effect with gold theme
        function createSparkle(x, y) {
            const sparkle = $('<div class="absolute w-10 h-10 pointer-events-none"></div>');
            sparkle.html('<i class="fas fa-star text-yellow-400 text-2xl absolute inset-0 flex items-center justify-center"></i>');
            
            sparkle.css({
                left: x - 20,
                top: y - 20,
                zIndex: 1000
            });
            
            $('body').append(sparkle);
            
            sparkle[0].animate([
                { transform: 'scale(0) rotate(0deg)', opacity: 1 },
                { transform: 'scale(2) rotate(180deg)', opacity: 0 }
            ], {
                duration: 800,
                easing: 'cubic-bezier(0.215, 0.610, 0.355, 1)'
            });
            
            setTimeout(() => sparkle.remove(), 800);
        }
        
        // Main initialization
        async function initializeApp() {
            // Check authentication
            state.token = localStorage.getItem('auth_token');
            state.user = JSON.parse(localStorage.getItem('user') || 'null');
            
            if (!state.token || !state.user) {
                window.location.href = 'index.html';
                return;
            }
            
            try {
                // Verify token is still valid
                const response = await fetch(`${API_BASE_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                
                if (!response.ok) {
                    throw new Error('Invalid token');
                }
                
                // Update user data
                const data = await response.json();
                if (data.success) {
                    state.user = { ...state.user, ...data.user };
                    localStorage.setItem('user', JSON.stringify(state.user));
                }
                
                // Update UI
                updateUserUI();
                
                // Load initial data
                await Promise.all([
                    loadSnacks(),
                    loadTodayVotes(),
                    loadOnlineUsers(),
                    loadUserStats()
                ]);
                
                // Start WebSocket connection
                connectWebSocket();
                
                // Start auto-refresh
                startAutoRefresh();
                
                // Start countdown timer
                startVotingTimer();
                
                // Show main app with animation
                setTimeout(() => {
                    $('#loading').fadeOut(500);
                    $('#mainApp').show().css('opacity', 0).animate({ opacity: 1 }, 800);
                }, 1000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Session expired. Please login again.', 'error');
                setTimeout(() => logout(), 2000);
            }
        }
        
        // Update user UI
        function updateUserUI() {
            $('#welcomeUser').text(`Welcome, ${state.user.employee_name}!`);
            $('#userName').text(state.user.employee_name);
            $('#userAvatar').text(state.user.avatar_emoji || 'üë§');
            $('#votesRemaining').text(state.hasVotedToday ? '0' : '1');
        }
        
        // Load snacks
        async function loadSnacks() {
            try {
                const response = await fetch(`${API_BASE_URL}/snacks`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    state.snacks = data.data;
                    renderSnacks();
                }
            } catch (error) {
                console.error('Failed to load snacks:', error);
            }
        }
        
        // Load today's votes
        async function loadTodayVotes() {
            try {
                const response = await fetch(`${API_BASE_URL}/vote/today`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    state.todayVotes = data.data.votes || [];
                    state.hasVotedToday = !!data.data.userVote;
                    
                    updateVotesUI(data.data);
                    updateVotingStatus();
                    updateUserUI();
                }
            } catch (error) {
                console.error('Failed to load votes:', error);
            }
        }
        
        // Load online users via HTTP
        async function loadOnlineUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/online-users`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    state.onlineUsers = data.onlineUsers || [];
                    updateOnlineUsersUI();
                }
            } catch (error) {
                console.error('Failed to load online users:', error);
            }
        }
        
        // Load user stats
        async function loadUserStats() {
            try {
                $('#myTotalVotes').text(state.user.total_votes || 0);
                $('#votedToday').text(state.hasVotedToday ? 'YES' : 'NO');
                if (state.hasVotedToday) {
                    $('#votedToday').addClass('from-green-600 to-emerald-600');
                }
                
                if (state.user.created_at) {
                    const date = new Date(state.user.created_at);
                    $('#memberSince').text(date.toLocaleDateString());
                }
            } catch (error) {
                console.error('Failed to load user stats:', error);
            }
        }
        
        // Render snacks with game effects
        function renderSnacks() {
            let html = '';
            state.snacks.forEach((snack, index) => {
                const voteCount = state.todayVotes.filter(v => v.snack_id === snack.id).length;
                const percentage = Math.min((voteCount / (state.todayVotes.length || 1)) * 100, 100);
                const userVote = state.todayVotes.find(v => v.user_id === state.user.id && v.snack_id === snack.id);
                const isVoted = !!userVote;
                
                // Gold gradient based on percentage
                const goldGradient = percentage > 50 ? 
                    'bg-gradient-to-r from-yellow-500 to-amber-500' : 
                    'bg-gradient-to-r from-yellow-300 to-amber-300';
                
                html += `
                    <div class="snack-card card-3d ${isVoted ? 'selected' : ''}" data-index="${index}">
                        ${isVoted ? '<div class="voted-badge">‚úì YOUR VOTE</div>' : ''}
                        <div class="card-content p-4 md:p-6">
                            <div class="text-6xl md:text-8xl text-center mb-4 md:mb-6 floating-emoji hover:scale-125 transition-transform duration-300">${snack.emoji}</div>
                            <h3 class="text-xl md:text-2xl font-bold text-center text-gray-800 mb-3 md:mb-4">${snack.name}</h3>
                            
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span><i class="fas fa-chart-bar mr-1"></i> VOTES</span>
                                    <span class="font-bold">${voteCount}</span>
                                </div>
                                <div class="bg-gray-300 rounded-full h-3 md:h-4 mb-2 md:mb-3 overflow-hidden">
                                    <div class="progress-bar h-full ${goldGradient}" 
                                         style="width: ${percentage}%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>0%</span>
                                    <span class="font-bold">${percentage.toFixed(1)}%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                            
                            <button onclick="submitVote(${snack.id}, event)" 
                                class="vote-btn w-full game-button ${isVoted ? 'opacity-50 cursor-default' : ''}"
                                ${state.hasVotedToday ? 'disabled' : ''}
                                data-snack-id="${snack.id}">
                                ${isVoted ? '‚úì VOTED!' : 'üéØ VOTE NOW!'}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            $('#snackGrid').html(html);
            
            // Add hover effects
            $('.snack-card').hover(
                function() {
                    if (!$(this).hasClass('selected')) {
                        $(this).addClass('glow-effect');
                    }
                },
                function() {
                    $(this).removeClass('glow-effect');
                }
            );
        }
        
        // Update votes UI
        function updateVotesUI(data) {
            // Update vote counts with animation
            const oldVotes = parseInt($('#totalVotesToday').text()) || 0;
            const newVotes = data.totalVotes;
            
            if (newVotes !== oldVotes) {
                $('#totalVotesToday').addClass('score-pop');
                setTimeout(() => $('#totalVotesToday').removeClass('score-pop'), 500);
            }
            
            $('#totalVotesToday').text(data.totalVotes);
            $('#voterCount').text(`${data.votes.length} PLAYERS`);
            
            // Update voters list
            let votersHtml = '';
            if (data.votes.length === 0) {
                votersHtml = `
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-6xl mb-4 animate-bounce">üë•</div>
                        <p class="text-xl">No votes yet today</p>
                        <p class="text-gray-500">Be the first to vote!</p>
                    </div>
                `;
            } else {
                data.votes.forEach(vote => {
                    const isCurrentUser = vote.user_id === state.user.id;
                    const isOnline = state.onlineUsers.some(u => u.userId === vote.user_id);
                    
                    votersHtml += `
                        <div class="flex items-center gap-3 md:gap-4 bg-gray-900 bg-opacity-50 rounded-2xl p-3 md:p-4 ${isCurrentUser ? 'border-2 border-yellow-400' : 'border border-gray-700'} hover:bg-gray-700 transition">
                            <div class="relative">
                                <span class="text-2xl md:text-3xl">${vote.avatar_emoji || 'üë§'}</span>
                                ${isOnline ? 
                                    '<div class="absolute -top-1 -right-1 w-2 md:w-3 h-2 md:h-3 bg-yellow-400 rounded-full online-dot"></div>' : 
                                    ''
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-bold ${isCurrentUser ? 'text-yellow-300' : 'text-white'} truncate">
                                    ${vote.employee_name} ${isCurrentUser ? '<span class="text-yellow-400">(YOU)</span>' : ''}
                                </p>
                                <p class="text-xs md:text-sm text-gray-400 truncate">${vote.department || 'Office'}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-3xl md:text-4xl">${vote.snack_emoji}</span>
                                <p class="text-xs text-gray-500 mt-1">Voted</p>
                            </div>
                        </div>
                    `;
                });
            }
            
            $('#votersList').html(votersHtml);
        }
        
        // Update online users UI
        function updateOnlineUsersUI() {
            const onlineCount = state.onlineUsers.filter(u => u.isOnline).length;
            
            // Add animation for count changes
            const oldCount = parseInt($('#onlineCount').text()) || 0;
            const oldNowCount = parseInt($('#onlineNowCount').text()) || 0;
            
            if (onlineCount !== oldCount) {
                $('#onlineCount').addClass('score-pop');
                setTimeout(() => $('#onlineCount').removeClass('score-pop'), 500);
            }
            
            if (onlineCount !== oldNowCount) {
                $('#onlineNowCount').addClass('score-pop');
                setTimeout(() => $('#onlineNowCount').removeClass('score-pop'), 500);
            }
            
            $('#onlineCount').text(onlineCount);
            $('#onlineNowCount').text(onlineCount);
            
            // Update online users list
            let onlineHtml = '';
            if (state.onlineUsers.length === 0) {
                onlineHtml = `
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-5xl mb-4 animate-pulse">üåê</div>
                        <p class="text-xl">No players online</p>
                        <p class="text-gray-500">Invite your friends!</p>
                    </div>
                `;
            } else {
                state.onlineUsers.forEach(user => {
                    const timeAgo = getTimeAgo(user.lastSeen);
                    
                    onlineHtml += `
                        <div class="flex items-center gap-3 md:gap-4 p-3 md:p-4 bg-gray-900 bg-opacity-50 hover:bg-gray-700 rounded-2xl transition border border-gray-700">
                            <div class="relative">
                                <span class="text-2xl md:text-3xl">${user.avatar || 'üë§'}</span>
                                ${user.isOnline ? 
                                    '<div class="absolute -top-1 -right-1 w-2 md:w-3 h-2 md:h-3 bg-yellow-400 rounded-full online-dot"></div>' : 
                                    '<div class="absolute -top-1 -right-1 w-2 md:w-3 h-2 md:h-3 bg-gray-400 rounded-full"></div>'
                                }
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-bold text-white truncate">${user.name}</p>
                                <p class="text-xs md:text-sm text-gray-400 truncate">${user.department || 'Office'}</p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 md:px-3 py-1 rounded-full text-xs font-bold ${user.isOnline ? 'bg-yellow-900 text-yellow-300' : 'bg-gray-700 text-gray-400'}">
                                    ${user.isOnline ? 'üéÆ LIVE' : 'üí§ AWAY'}
                                </span>
                                <p class="text-xs text-gray-500 mt-1 truncate">${timeAgo}</p>
                            </div>
                        </div>
                    `;
                });
            }
            
            $('#onlineUsersList').html(onlineHtml);
        }
        
        // Enhanced Submit vote with animations
        async function submitVote(snackId, event) {
            if (state.hasVotedToday) {
                showNotification('You have already voted today!', 'error');
                return;
            }
            
            const snack = state.snacks.find(s => s.id === snackId);
            
            // Get button position for animations
            const button = $(event.target);
            const rect = button[0].getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            
            // Create click animation
            createSparkle(x, y);
            
            // Create confetti at button position
            createConfetti(x, y);
            
            // Add button click effect
            button.addClass('opacity-70');
            
            if (confirm(`üéØ Are you sure you want to vote for ${snack.emoji} ${snack.name}?`)) {
                try {
                    const response = await fetch(`${API_BASE_URL}/vote/submit`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ snackId })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Update state
                        state.hasVotedToday = true;
                        
                        // Play victory sound (if audio is allowed)
                        if (typeof Audio !== 'undefined') {
                            try {
                                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3');
                                audio.volume = 0.3;
                                audio.play().catch(() => {});
                            } catch (e) {}
                        }
                        
                        // Show success notification
                        showNotification(`üéâ Voted for ${snack.emoji} ${snack.name}!`, 'success');
                        
                        // Update UI with animations
                        $('#votesRemaining').text('0');
                        $('.vote-btn').prop('disabled', true).addClass('opacity-50');
                        $(`.snack-card[data-snack-id="${snackId}"]`).addClass('selected');
                        
                        // Reload data
                        await loadTodayVotes();
                        await loadUserStats();
                        
                        // Send vote via WebSocket
                        if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                            state.ws.send(JSON.stringify({
                                type: 'vote',
                                data: {
                                    userId: state.user.id,
                                    snackId,
                                    timestamp: new Date().toISOString()
                                }
                            }));
                        }
                        
                        // Add voted badge animation
                        const card = $(`.snack-card[data-snack-id="${snackId}"]`);
                        card.prepend('<div class="voted-badge animate-vote-pop">‚úì YOUR VOTE</div>');
                        
                    } else {
                        showNotification(data.error || 'Vote failed!', 'error');
                    }
                } catch (error) {
                    showNotification('Network error. Please try again.', 'error');
                }
            }
            
            button.removeClass('opacity-70');
        }
        
        // WebSocket connection
        function connectWebSocket() {
            if (!state.token) return;
            
            // Close any existing WebSocket connection and clear heartbeat interval
            if (state.ws) {
                state.ws.close();
            }
            if (state.wsHeartbeatInterval) {
                clearInterval(state.wsHeartbeatInterval);
                state.wsHeartbeatInterval = null;
            }
            
            const wsUrl = `ws://localhost:3000?token=${state.token}`;
            state.ws = new WebSocket(wsUrl);
            
            state.ws.onopen = () => {
                console.log('WebSocket connected');
                
                // Start heartbeat and store the interval ID
                if (state.wsHeartbeatInterval) {
                    clearInterval(state.wsHeartbeatInterval);
                }
                state.wsHeartbeatInterval = setInterval(() => {
                    if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                        state.ws.send(JSON.stringify({ type: 'heartbeat' }));
                    }
                }, 15000);
            };
            
            state.ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    switch (data.type) {
                        case 'online_users':
                            state.onlineUsers = data.data.map(user => ({
                                ...user,
                                isOnline: (Date.now() - user.lastSeen) < 30000
                            }));
                            updateOnlineUsersUI();
                            break;
                            
                        case 'new_vote':
                            // Add new vote to list
                            state.todayVotes.unshift({
                                user_id: data.data.userId,
                                employee_name: data.data.employee_name,
                                avatar_emoji: data.data.avatar_emoji,
                                department: data.data.department,
                                snack_id: data.data.snack_id,
                                snack_name: data.data.snack_name,
                                snack_emoji: data.data.snack_emoji
                            });
                            
                            updateVotesUI({
                                votes: state.todayVotes,
                                totalVotes: state.todayVotes.length
                            });
                            
                            // Show notification for new vote
                            if (data.data.userId !== state.user.id) {
                                showNotification(`${data.data.employee_name} voted for ${data.data.snack_emoji}!`, 'info');
                            }
                            break;
                    }
                } catch (error) {
                    console.error('WebSocket message error:', error);
                }
            };
            
            state.ws.onclose = () => {
                console.log('WebSocket disconnected');
                
                // Clear heartbeat interval when connection closes
                if (state.wsHeartbeatInterval) {
                    clearInterval(state.wsHeartbeatInterval);
                    state.wsHeartbeatInterval = null;
                }
                
                // Try to reconnect after 5 seconds
                state.wsReconnectInterval = setTimeout(connectWebSocket, 5000);
            };
            
            state.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        // Auto-refresh
        function startAutoRefresh() {
            if (state.refreshInterval) {
                clearInterval(state.refreshInterval);
            }
            
            state.refreshInterval = setInterval(async () => {
                await loadTodayVotes();
                await loadOnlineUsers();
            }, 10000); // Every 10 seconds
        }
        
        // Voting timer
        function startVotingTimer() {
            function updateTimer() {
                const now = new Date();
                const endTime = new Date();
                endTime.setHours(VOTING_END_HOUR, 0, 0, 0);
                
                if (now >= endTime) {
                    $('#countdown').text('TIME\'S UP!').addClass('text-red-400');
                    $('.vote-btn').prop('disabled', true).addClass('opacity-50');
                    return;
                }
                
                const diff = endTime - now;
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                const timerText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Add animation when time is running low
                if (hours === 0 && minutes < 5) {
                    $('#countdown').addClass('text-red-400 animate-pulse');
                } else {
                    $('#countdown').removeClass('text-red-400 animate-pulse');
                }
                
                $('#countdown').text(timerText);
            }
            
            updateTimer();
            setInterval(updateTimer, 1000);
        }
        
        function updateVotingStatus() {
            const now = new Date();
            const currentHour = now.getHours();
            
            if (currentHour >= VOTING_END_HOUR) {
                $('.vote-btn').prop('disabled', true).addClass('opacity-50');
            }
        }
        
        // Helper functions
        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            if (diff < 60000) return 'just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return `${Math.floor(diff / 86400000)}d ago`;
        }
        
        // Profile functions
        function showProfile() {
            $('#profileContent').html(`
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
                        <div class="relative">
                            <span class="text-7xl floating-emoji">${state.user.avatar_emoji || 'üë§'}</span>
                            <div class="absolute -bottom-2 -right-2 w-6 h-6 bg-gradient-to-r from-yellow-400 to-amber-500 rounded-full border-4 border-gray-900"></div>
                        </div>
                        <div class="text-center md:text-left">
                            <h4 class="text-2xl font-bold">${state.user.employee_name}</h4>
                            <p class="text-gray-400">${state.user.department || 'General'}</p>
                            <div class="flex flex-wrap justify-center md:justify-start items-center gap-2 mt-2">
                                <span class="px-3 py-1 bg-gradient-to-r from-yellow-600 to-amber-600 rounded-full text-xs font-bold">PLAYER</span>
                                <span class="px-3 py-1 bg-gradient-to-r from-amber-600 to-orange-600 rounded-full text-xs font-bold">LEVEL 1</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-700 rounded-2xl p-4">
                            <p class="text-sm text-gray-400">Employee ID</p>
                            <p class="font-bold text-xl">${state.user.employee_id}</p>
                        </div>
                        <div class="bg-gray-700 rounded-2xl p-4">
                            <p class="text-sm text-gray-400">Total Votes</p>
                            <p class="font-bold text-xl">${state.user.total_votes || 0}</p>
                        </div>
                    </div>
                    
                    ${state.user.email ? `
                        <div class="bg-gray-700 rounded-2xl p-4">
                            <p class="text-sm text-gray-400">Email</p>
                            <p class="font-bold truncate">${state.user.email}</p>
                        </div>
                    ` : ''}
                    
                    <div class="bg-gray-700 rounded-2xl p-4">
                        <p class="text-sm text-gray-400">Member Since</p>
                        <p class="font-bold">${new Date(state.user.created_at).toLocaleDateString()}</p>
                    </div>
                </div>
            `);
            
            $('#profileModal').removeClass('hidden').addClass('flex');
        }
        
        function hideProfile() {
            $('#profileModal').removeClass('flex').addClass('hidden');
        }
        
        function showChangePassword() {
            $('#changePasswordForm')[0].reset();
            $('#passwordMessage').addClass('hidden').empty();
            $('#changePasswordModal').removeClass('hidden').addClass('flex');
        }
        
        function hideChangePassword() {
            $('#changePasswordModal').removeClass('flex').addClass('hidden');
        }
        
        // Change password form
        $('#changePasswordForm').submit(async function(e) {
            e.preventDefault();
            
            const currentPassword = $('#currentPassword').val();
            const newPassword = $('#newPassword').val();
            const confirmPassword = $('#confirmNewPassword').val();
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showPasswordMessage('Please fill all fields', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showPasswordMessage('New password must be at least 6 characters', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showPasswordMessage('Passwords do not match', 'error');
                return;
            }
            
            const btn = $(this).find('button[type="submit"]');
            btn.prop('disabled', true).text('UPDATING...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showPasswordMessage('Password changed successfully! Please login again.', 'success');
                    
                    setTimeout(() => {
                        logout();
                    }, 2000);
                } else {
                    showPasswordMessage(data.error || 'Failed to change password', 'error');
                }
            } catch (error) {
                showPasswordMessage('Network error. Please try again.', 'error');
            }
            
            btn.prop('disabled', false).text('UPDATE PASSWORD');
        });
        
        function showPasswordMessage(message, type) {
            const messageDiv = $('#passwordMessage');
            messageDiv.removeClass('hidden bg-green-900 text-green-300 bg-red-900 text-red-300');
            
            if (type === 'success') {
                messageDiv.addClass('bg-green-900 text-green-300');
            } else {
                messageDiv.addClass('bg-red-900 text-red-300');
            }
            
            messageDiv.html(`<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle mr-3"></i> ${message}`);
            messageDiv.removeClass('hidden');
        }
        
        // Online users modal
        function showOnlineUsers() {
            let html = '<div class="space-y-4">';
            
            state.onlineUsers.forEach(user => {
                const timeAgo = getTimeAgo(user.lastSeen);
                
                html += `
                    <div class="flex items-center gap-3 md:gap-4 p-4 bg-gray-700 rounded-2xl hover:bg-gray-600 transition">
                        <div class="relative">
                            <span class="text-2xl md:text-3xl">${user.avatar || 'üë§'}</span>
                            ${user.isOnline ? 
                                '<div class="absolute -top-1 -right-1 w-2 md:w-3 h-2 md:h-3 bg-yellow-400 rounded-full online-dot"></div>' : 
                                '<div class="absolute -top-1 -right-1 w-2 md:w-3 h-2 md:h-3 bg-gray-400 rounded-full"></div>'
                            }
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-white truncate">${user.name}</h4>
                            <p class="text-sm text-gray-400 truncate">${user.department || 'Office'}</p>
                            <p class="text-xs text-gray-500">Last active: ${timeAgo}</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 md:px-4 py-1 md:py-2 rounded-full text-xs font-bold ${user.isOnline ? 'bg-yellow-900 text-yellow-300' : 'bg-gray-600 text-gray-400'}">
                                ${user.isOnline ? 'üéÆ ONLINE' : 'üí§ AWAY'}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            $('#onlineUsersModalContent').html(html);
            $('#onlineUsersModal').removeClass('hidden').addClass('flex');
        }
        
        function hideOnlineUsers() {
            $('#onlineUsersModal').removeClass('flex').addClass('hidden');
        }
        
        // Other functions
        function showLeaderboard() {
            showNotification('üèÜ Leaderboard feature coming soon!', 'info');
        }
        
        function showHistory() {
            showNotification('üìä Voting history feature coming soon!', 'info');
        }
        
        function refreshData() {
            Promise.all([
                loadSnacks(),
                loadTodayVotes(),
                loadOnlineUsers(),
                loadUserStats()
            ]).then(() => {
                showNotification('Data refreshed!', 'success');
            });
        }
        
        // Logout
        function logout() {
            // Send logout request
            fetch(`${API_BASE_URL}/auth/logout`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${state.token}` }
            }).catch(() => {
                // Ignore errors
            });
            
            // Clear local storage
            localStorage.clear();
            
            // Disconnect WebSocket
            if (state.ws) {
                state.ws.close();
            }
            
            // Clear intervals
            if (state.refreshInterval) {
                clearInterval(state.refreshInterval);
            }
            
            if (state.wsReconnectInterval) {
                clearInterval(state.wsReconnectInterval);
            }
            
            // Show logout notification
            showNotification('Logged out successfully!', 'info');
            
            // Redirect to login
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }
    </script>
</body>
</html>